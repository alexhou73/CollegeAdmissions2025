<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>æ™®é€šæ‰¹å¤§å­¦åˆ†å¸ƒå¤§å±</title>
    <script src="/static/echarts.min.js"></script>
    <style>
        body { background: #f5f6fa; margin: 0; font-family: 'Microsoft YaHei', Arial; }
        .container { display: flex; flex-direction: row; justify-content: center; align-items: flex-start; gap: 20px; width: 96vw; max-width: 1400px; margin: 0 auto; }
        .left-panel, .right-panel { min-width: 0; }
        .left-panel { width: 60%; min-width: 400px; margin: 20px 0 20px 0; }
        .right-panel { width: 40%; min-width: 350px; display: flex; flex-direction: column; gap: 20px; margin: 20px 0 20px 0; }
        .chart-box { background: #fff; border-radius: 10px; box-shadow: 0 2px 8px #eee; padding: 10px; width: 100%; box-sizing: border-box; }
        #chinaMap { width: 100%; height: 700px; }
        #barChart { width: 100%; height: 330px; }
        #pieChart { width: 100%; height: 330px; }
        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 80px;
            text-align: center;
            flex: 1;
        }
        .stat-enroll .stat-label {
            color: #1a355b !important;
            font-weight: bold;
        }
        .stat-enroll .stat-value {
            color: #e74c3c !important;
            font-weight: bold;
            font-size: 1.1em;
        }
        .stat-label {
            color: #4a6fa1;
            font-size: 0.98em;
            margin-bottom: 4px;
            letter-spacing: 0.5px;
        }
        .stat-value {
            color: #1a355b;
            font-size: 1.3em;
            font-weight: bold;
            letter-spacing: 0.5px;
        }
        /* è¡¨æ ¼å­—ä½“æ”¾å¤§ */
        #university-table { font-size: 17px !important; }
        #university-table th, #university-table td { padding: 10px 8px; }
        /* åˆ†é¡µæŒ‰é’®å­—ä½“æ”¾å¤§ */
        #prev-page, #next-page, #page-info { font-size: 16px; }
        /* è®©è¡¨æ ¼å’Œä¸Šæ–¹å›¾è¡¨å®½åº¦ä¸€è‡´ */
        .table-container { width: 96vw; max-width: 1400px; margin: 20px auto; }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            #stats-bar > div {
                flex-direction: column !important;
                gap: 15px !important;
            }
            .stat-item {
                min-width: 60px;
            }
            /* åœ¨å°å±å¹•ä¸Šéšè—åˆ†éš”çº¿ */
            #stats-bar > div > div[style*="height: 40px"] {
                display: none !important;
            }
        }
    </style>
</head>
<body>
    <h1 style="text-align:center;">2025å¹´å…¨å›½å¤§å­¦ï¼ˆæ™®é€šï¼‰æ‹›ç”Ÿæƒ…å†µ</h1>
    <!-- ç»Ÿä¸€çš„ä¿¡æ¯æ  -->
    <div id="stats-bar" style="width:96vw;max-width:1400px;margin:0 auto 18px auto;padding:0;">
        <div style="
            background: linear-gradient(135deg, #e3f0fc 0%, #f6fafd 100%);
            border-radius: 12px;
            box-shadow: 0 2px 8px #e0e7ef44;
            padding: 20px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 24px;
            border: 1px solid rgba(227, 240, 252, 0.3);
        ">
            <div class="stat-item">
                <div class="stat-label">å¤§å­¦æ€»æ•°</div>
                <div class="stat-value" id="stat-total">-</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">985å¤§å­¦</div>
                <div class="stat-value" id="stat-985">-</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">åŒä¸€æµå¤§å­¦</div>
                <div class="stat-value" id="stat-216">-</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">211å¤§å­¦</div>
                <div class="stat-value" id="stat-211">-</div>
            </div>
            <div style="width: 1px; height: 40px; background: rgba(26, 53, 91, 0.2); margin: 0 5px;"></div>
            <div class="stat-item">
                <div class="stat-label">å…¬åŠå¤§å­¦</div>
                <div class="stat-value" id="stat-public">-</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">æ°‘åŠå¤§å­¦</div>
                <div class="stat-value" id="stat-private">-</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">å…¶å®ƒ</div>
                <div class="stat-value" id="stat-other">-</div>
            </div>
            <div style="width: 1px; height: 40px; background: rgba(26, 53, 91, 0.2); margin: 0 5px;"></div>
            <div class="stat-item stat-enroll">
                <div class="stat-label">æ‹›ç”Ÿæ€»æ•° *</div>
                <div class="stat-value" id="stat-enroll">-</div>
            </div>
        </div>
    </div>
    <div class="container">
        <div class="left-panel">
            <div class="chart-box">
                <div style="position: relative;">
                    <div id="chinaMap"></div>
                    <!-- åœ°å›¾æ§åˆ¶æŒ‰é’® -->
                    <div style="position: absolute; top: 15px; right: 15px; z-index: 1000;">
                        <button id="back-to-national" onclick="backToNational()" style="
                            background: rgba(255, 255, 255, 0.9);
                            border: 1px solid #ddd;
                            border-radius: 6px;
                            padding: 8px 12px;
                            font-size: 12px;
                            cursor: pointer;
                            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                            color: #666;
                            font-family: 'Microsoft YaHei', Arial;
                            transition: all 0.2s;
                        " onmouseover="this.style.background='rgba(255,255,255,1)';this.style.color='#333'" onmouseout="this.style.background='rgba(255,255,255,0.9)';this.style.color='#666'">
                            ğŸ  è¿”å›å…¨å›½
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <div class="right-panel">
            <div class="chart-box"><div id="barChart"></div></div>
            <div class="chart-box"><div id="pieChart"></div></div>
        </div>
    </div>
    
    <!-- åœ°å›¾æ“ä½œæç¤º -->
    <div style="width:96vw;max-width:1400px;margin:10px auto;text-align:center;">
        <div style="background: #f8f9fa; border-radius: 8px; padding: 12px; color: #666; font-size: 13px; border: 1px solid #e9ecef;">
            <span style="margin-right: 20px;">ğŸ’¡ <strong>åœ°å›¾æ“ä½œæç¤ºï¼š</strong></span>
            <span style="margin-right: 15px;">ğŸ–±ï¸ é¼ æ ‡æ»šè½®ç¼©æ”¾</span>
            <span style="margin-right: 15px;">ğŸ‘† æŒ‰ä½æ‹–æ‹½ç§»åŠ¨</span>
            <span style="margin-right: 15px;">ğŸ–±ï¸ å•å‡»æŸ¥çœ‹çœä»½è¯¦æƒ…</span>
            <span style="margin-right: 15px;">ğŸ–±ï¸ åŒå‡»è¿”å›å…¨å›½è§†å›¾</span>
            <span style="margin-right: 20px;">ğŸ  ç‚¹å‡»å³ä¸Šè§’æŒ‰é’®è¿”å›å…¨å›½</span>
            <span>* æ‹›ç”Ÿæ€»æ•°å…·ä½“è§åº•éƒ¨å¤§å­¦è¯¦ç»†ä¿¡æ¯<strong style="color: #1e6bb8;">2025å¹´è®¡åˆ’æ‹›ç”Ÿæ€»æ•°</strong></span>
        </div>
    </div>
    
    <!-- å¤§å­¦è¯¦ç»†ä¿¡æ¯è¡¨æ ¼ -->
    <div class="table-container">
        <div class="chart-box" style="padding: 20px;">
            <h3 id="table-title" style="text-align: center; margin-bottom: 20px; color: #1a355b;">å…¨å›½å¤§å­¦è¯¦ç»†ä¿¡æ¯</h3>
            
            <!-- è¡¨æ ¼å®¹å™¨ -->
            <div style="overflow-x: auto;">
                <table id="university-table" style="width: 100%; border-collapse: collapse; font-size: 14px;">
                    <thead>
                        <tr style="background: linear-gradient(135deg, #e3f0fc 0%, #f6fafd 100%);">
                            <th style="padding: 12px 8px; border: 1px solid #ddd; text-align: center; font-weight: bold; color: #1a355b;">å­¦æ ¡ä»£ç </th>
                            <th style="padding: 12px 8px; border: 1px solid #ddd; text-align: center; font-weight: bold; color: #1a355b;">å­¦æ ¡åç§°</th>
                            <th style="padding: 12px 8px; border: 1px solid #ddd; text-align: center; font-weight: bold; color: #1a355b;">å±‚æ¬¡</th>
                            <th style="padding: 12px 8px; border: 1px solid #ddd; text-align: center; font-weight: bold; color: #1a355b;">ä½ç½®</th>
                            <th style="padding: 12px 8px; border: 1px solid #ddd; text-align: center; font-weight: bold; color: #1a355b; min-width: 120px;">ä¸“ä¸šä»£ç </th>
                            <th style="padding: 12px 8px; border: 1px solid #ddd; text-align: center; font-weight: bold; color: #1a355b;">2025å¹´è®¡åˆ’æ‹›ç”Ÿæ€»æ•°</th>
                            <th style="padding: 12px 8px; border: 1px solid #ddd; text-align: center; font-weight: bold; color: #1a355b;">2025å¹´ä¼°åˆ†</th>
                            <th style="padding: 12px 8px; border: 1px solid #ddd; text-align: center; font-weight: bold; color: #1a355b;">é¡µç èŒƒå›´</th>
                        </tr>
                    </thead>
                    <tbody id="table-body">
                        <!-- è¡¨æ ¼å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </tbody>
                </table>
            </div>
            
            <!-- åˆ†é¡µæ§ä»¶ -->
            <div style="display: flex; justify-content: center; align-items: center; margin-top: 20px; gap: 10px;">
                <button id="prev-page" onclick="changePage(-1)" style="
                    padding: 8px 16px;
                    background: linear-gradient(135deg, #e3f0fc 0%, #f6fafd 100%);
                    color: #357abd;
                    border: none;
                    border-radius: 6px;
                    cursor: pointer;
                    font-family: 'Microsoft YaHei', Arial;
                    transition: all 0.2s;
                " onmouseover="this.style.background='linear-gradient(135deg, #d0e7fa 0%, #eaf4fb 100%)'" onmouseout="this.style.background='linear-gradient(135deg, #e3f0fc 0%, #f6fafd 100%)'">
                    ä¸Šä¸€é¡µ
                </button>
                <span id="page-info" style="color: #1a355b; font-weight: bold;">ç¬¬ 1 é¡µï¼Œå…± 1 é¡µ</span>
                <button id="next-page" onclick="changePage(1)" style="
                    padding: 8px 16px;
                    background: linear-gradient(135deg, #e3f0fc 0%, #f6fafd 100%);
                    color: #357abd;
                    border: none;
                    border-radius: 6px;
                    cursor: pointer;
                    font-family: 'Microsoft YaHei', Arial;
                    transition: all 0.2s;
                " onmouseover="this.style.background='linear-gradient(135deg, #d0e7fa 0%, #eaf4fb 100%)'" onmouseout="this.style.background='linear-gradient(135deg, #e3f0fc 0%, #f6fafd 100%)'">
                    ä¸‹ä¸€é¡µ
                </button>
            </div>
        </div>
    </div>
    <script>
    // çœä»½åæ ‡å‡†åŒ–æ˜ å°„
    const provinceNameMap = {
        'åŒ—äº¬': 'åŒ—äº¬å¸‚', 'å¤©æ´¥': 'å¤©æ´¥å¸‚', 'ä¸Šæµ·': 'ä¸Šæµ·å¸‚', 'é‡åº†': 'é‡åº†å¸‚',
        'æ²³åŒ—': 'æ²³åŒ—çœ', 'å±±è¥¿': 'å±±è¥¿çœ', 'è¾½å®': 'è¾½å®çœ', 'å‰æ—': 'å‰æ—çœ', 'é»‘é¾™æ±Ÿ': 'é»‘é¾™æ±Ÿçœ',
        'æ±Ÿè‹': 'æ±Ÿè‹çœ', 'æµ™æ±Ÿ': 'æµ™æ±Ÿçœ', 'å®‰å¾½': 'å®‰å¾½çœ', 'ç¦å»º': 'ç¦å»ºçœ', 'æ±Ÿè¥¿': 'æ±Ÿè¥¿çœ',
        'å±±ä¸œ': 'å±±ä¸œçœ', 'æ²³å—': 'æ²³å—çœ', 'æ¹–åŒ—': 'æ¹–åŒ—çœ', 'æ¹–å—': 'æ¹–å—çœ', 'å¹¿ä¸œ': 'å¹¿ä¸œçœ',
        'æµ·å—': 'æµ·å—çœ', 'å››å·': 'å››å·çœ', 'è´µå·': 'è´µå·çœ', 'äº‘å—': 'äº‘å—çœ', 'é™•è¥¿': 'é™•è¥¿çœ',
        'ç”˜è‚ƒ': 'ç”˜è‚ƒçœ', 'é’æµ·': 'é’æµ·çœ', 'å°æ¹¾': 'å°æ¹¾çœ', 'å†…è’™å¤': 'å†…è’™å¤è‡ªæ²»åŒº', 'å¹¿è¥¿': 'å¹¿è¥¿å£®æ—è‡ªæ²»åŒº',
        'è¥¿è—': 'è¥¿è—è‡ªæ²»åŒº', 'å®å¤': 'å®å¤å›æ—è‡ªæ²»åŒº', 'æ–°ç–†': 'æ–°ç–†ç»´å¾å°”è‡ªæ²»åŒº', 'é¦™æ¸¯': 'é¦™æ¸¯ç‰¹åˆ«è¡Œæ”¿åŒº', 'æ¾³é—¨': 'æ¾³é—¨ç‰¹åˆ«è¡Œæ”¿åŒº'
    };
    // åå‘æ˜ å°„
    const provinceNameMapReverse = Object.fromEntries(Object.entries(provinceNameMap).map(([k,v])=>[v,k]));
    // çœä»½è‹±æ–‡åæ˜ å°„ï¼ˆç”¨äºgeojsonæ–‡ä»¶åï¼‰
    const provinceEnMap = {
        'åŒ—äº¬å¸‚': 'beijing', 'å¤©æ´¥å¸‚': 'tianjin', 'ä¸Šæµ·å¸‚': 'shanghai', 'é‡åº†å¸‚': 'chongqing',
        'æ²³åŒ—çœ': 'hebei', 'å±±è¥¿çœ': 'shanxi', 'è¾½å®çœ': 'liaoning', 'å‰æ—çœ': 'jilin', 'é»‘é¾™æ±Ÿçœ': 'heilongjiang',
        'æ±Ÿè‹çœ': 'jiangsu', 'æµ™æ±Ÿçœ': 'zhejiang', 'å®‰å¾½çœ': 'anhui', 'ç¦å»ºçœ': 'fujian', 'æ±Ÿè¥¿çœ': 'jiangxi',
        'å±±ä¸œçœ': 'shandong', 'æ²³å—çœ': 'henan', 'æ¹–åŒ—çœ': 'hubei', 'æ¹–å—çœ': 'hunan', 'å¹¿ä¸œçœ': 'guangdong',
        'æµ·å—çœ': 'hainan', 'å››å·çœ': 'sichuan', 'è´µå·çœ': 'guizhou', 'äº‘å—çœ': 'yunnan', 'é™•è¥¿çœ': 'shaanxi',
        'ç”˜è‚ƒçœ': 'gansu', 'é’æµ·çœ': 'qinghai', 'å°æ¹¾çœ': 'taiwan', 'å†…è’™å¤è‡ªæ²»åŒº': 'neimenggu', 'å¹¿è¥¿å£®æ—è‡ªæ²»åŒº': 'guangxi',
        'è¥¿è—è‡ªæ²»åŒº': 'xizang', 'å®å¤å›æ—è‡ªæ²»åŒº': 'ningxia', 'æ–°ç–†ç»´å¾å°”è‡ªæ²»åŒº': 'xinjiang', 'é¦™æ¸¯ç‰¹åˆ«è¡Œæ”¿åŒº': 'xianggang', 'æ¾³é—¨ç‰¹åˆ«è¡Œæ”¿åŒº': 'aomen'
    };

    let currentMap = 'china';
    let currentTitle = 'å„çœå¤§å­¦æ•°é‡åˆ†å¸ƒ';
    let mapChart;
    let provinceTotalCache = [];
    let currentProvince = null;
    let provincePie; // å³ä¾§ä¸Šæ–¹å›¾è¡¨
    let pieChart;    // å³ä¾§ä¸‹æ–¹å›¾è¡¨
    
    // è¡¨æ ¼ç›¸å…³å˜é‡
    let currentTablePage = 1;
    let currentTableProvince = null;
    let totalTablePages = 1;

    function getColorByCount(count, maxCount) {
        if (count === 0) return '#f0f0f0'; // ç°è‰²
        const ratio = count / maxCount;
        if (ratio >= 0.75) return '#FF0000'; // çº¢è‰²
        if (ratio >= 0.5) return '#FFA500';  // æ©™è‰²
        if (ratio >= 0.25) return '#FFFF00'; // é»„è‰²
        return '#00FF00'; // ç»¿è‰²
    }

    function updateRightCharts(provinceName, cityData, levelData) {
        // Update city distribution chart (top right)
        if (cityData && cityData.length > 0) {
            provincePie.setOption({
                title: { text: provinceName + 'å„åŸå¸‚å¤§å­¦æ•°é‡', left: 'center' },
                series: [{
                    data: cityData.map(item => ({
                        name: item.name,
                        value: item.value
                    }))
                }]
            });
        }
        
        // Update level distribution chart (bottom right)
        if (levelData && levelData.length > 0) {
            pieChart.setOption({
                title: { text: provinceName + 'å¤§å­¦å±‚æ¬¡å æ¯”', left: 'center' },
                series: [{
                    data: levelData.map(item => ({
                        name: item.å±‚æ¬¡,
                        value: item.æ•°é‡
                    }))
                }]
            });
        }
    }

    function resetRightCharts() {
        // Reset to national level
        provincePie.setOption({
            title: { text: 'å„çœå¤§å­¦æ•°é‡', left: 'center' },
            series: [{
                data: provinceTotalCache.map(item => ({
                    name: provinceNameMap[item['çœä»½']],
                    value: item['æ€»æ•°']
                }))
            }]
        });
        
        // Reset level chart to national level
        fetch('/api/province_level_stats').then(r => r.json()).then(data => {
            pieChart.setOption({
                title: { text: 'å¤§å­¦å±‚æ¬¡å æ¯”', left: 'center' },
                series: [{
                    data: data.level_total.map(item => ({
                        name: item['å±‚æ¬¡'],
                        value: item['æ€»æ•°']
                    }))
                }]
            });
        });
    }



    function backToNational() {
        if (currentMap !== 'china') {
            currentProvince = null;
            currentMap = 'china';
            // é‡æ–°åŠ è½½å…¨å›½åœ°å›¾
            fetch('/static/maps/china.json').then(r => r.json()).then(geoJson => {
                renderMap('china', geoJson, 'å„çœå¤§å­¦æ•°é‡åˆ†å¸ƒ', provinceTotalCache.map(item => ({
                    name: provinceNameMap[item['çœä»½']],
                    value: item['æ€»æ•°']
                })));
                resetRightCharts();
                // æ›´æ–°è¡¨æ ¼ä¸ºå…¨å›½æ•°æ®
                loadUniversityTable(null, 1);
                updateStatBar();
            });
        }
    }

    function loadUniversityTable(province = null, page = 1) {
        let url = `/api/university_details?page=${page}&page_size=10`;
        if (province) {
            url += `&province=${province}`;
        }
        
        fetch(url).then(r => r.json()).then(data => {
            // æ›´æ–°è¡¨æ ¼æ ‡é¢˜
            const tableTitle = document.getElementById('table-title');
            if (province) {
                tableTitle.textContent = `${province}å¤§å­¦è¯¦ç»†ä¿¡æ¯`;
            } else {
                tableTitle.textContent = 'å…¨å›½å¤§å­¦è¯¦ç»†ä¿¡æ¯';
            }
            
            // æ›´æ–°è¡¨æ ¼å†…å®¹
            const tableBody = document.getElementById('table-body');
            tableBody.innerHTML = '';
            
            data.universities.forEach(univ => {
                const row = document.createElement('tr');
                row.style.borderBottom = '1px solid #ddd';
                row.style.transition = 'background-color 0.2s';
                row.onmouseover = function() {
                    this.style.backgroundColor = '#f8f9fa';
                };
                row.onmouseout = function() {
                    this.style.backgroundColor = '';
                };
                row.innerHTML = `
                    <td style="padding: 10px 8px; border: 1px solid #ddd; text-align: center;">${univ.å­¦æ ¡ä»£ç  || '-'}</td>
                    <td style="padding: 10px 8px; border: 1px solid #ddd; text-align: center; font-weight: bold;">${univ.å­¦æ ¡åç§° || '-'}</td>
                    <td style="padding: 10px 8px; border: 1px solid #ddd; text-align: center;">${univ.å±‚æ¬¡ || '-'}</td>
                    <td style="padding: 10px 8px; border: 1px solid #ddd; text-align: center;">${univ.ä½ç½® || '-'}</td>
                    <td style="padding: 10px 8px; border: 1px solid #ddd; text-align: center; line-height: 1.6; min-width: 120px; vertical-align: middle;">${formatMajorCodes(univ.ä¸“ä¸šä»£ç )}</td>
                    <td style="padding: 10px 8px; border: 1px solid #ddd; text-align: center;">${univ['2025å¹´è®¡åˆ’æ‹›ç”Ÿæ€»æ•°'] || '-'}</td>
                    <td style="padding: 10px 8px; border: 1px solid #ddd; text-align: center;">${univ['2025å¹´ä¼°åˆ†'] || '-'}</td>
                    <td style="padding: 10px 8px; border: 1px solid #ddd; text-align: center;">${univ.é¡µç èŒƒå›´ || '-'}</td>
                `;
                tableBody.appendChild(row);
            });
            
            // æ›´æ–°åˆ†é¡µä¿¡æ¯
            currentTablePage = data.current_page;
            totalTablePages = data.total_pages;
            currentTableProvince = province;
            
            document.getElementById('page-info').textContent = `ç¬¬ ${data.current_page} é¡µï¼Œå…± ${data.total_pages} é¡µ`;
            
            // æ›´æ–°åˆ†é¡µæŒ‰é’®çŠ¶æ€
            document.getElementById('prev-page').disabled = data.current_page <= 1;
            document.getElementById('next-page').disabled = data.current_page >= data.total_pages;
            
            // æ›´æ–°æŒ‰é’®æ ·å¼
            const prevBtn = document.getElementById('prev-page');
            const nextBtn = document.getElementById('next-page');
            
            if (data.current_page <= 1) {
                prevBtn.style.opacity = '0.5';
                prevBtn.style.cursor = 'not-allowed';
            } else {
                prevBtn.style.opacity = '1';
                prevBtn.style.cursor = 'pointer';
            }
            
            if (data.current_page >= data.total_pages) {
                nextBtn.style.opacity = '0.5';
                nextBtn.style.cursor = 'not-allowed';
            } else {
                nextBtn.style.opacity = '1';
                nextBtn.style.cursor = 'pointer';
            }
        }).catch(error => {
            console.error('Error loading university table:', error);
        });
    }

    function changePage(delta) {
        const newPage = currentTablePage + delta;
        if (newPage >= 1 && newPage <= totalTablePages) {
            loadUniversityTable(currentTableProvince, newPage);
        }
    }

    function renderMap(mapName, geoJson, title, data, isCityLevel = false) {
        echarts.registerMap(mapName, geoJson);
        const maxCount = Math.max(...data.map(d => d.value || 0));
        
        mapChart.setOption({
            title: { text: title, left: 'center' },
            tooltip: {
                trigger: 'item',
                formatter: function(params) {
                    if (isCityLevel) {
                        // åŸå¸‚çº§åˆ«tooltip
                        return `${params.name}ï¼š${params.value || 0} æ‰€å¤§å­¦`;
                    } else {
                        // çœä»½çº§åˆ«tooltip
                        let zhName = provinceNameMapReverse[params.name] || params.name;
                        return `${zhName}ï¼š${params.value || 0} æ‰€å¤§å­¦`;
                    }
                }
            },
            visualMap: {
                min: 0,
                max: maxCount,
                left: 'left',
                top: 'bottom',
                text: ['å¤š','å°‘'],
                inRange: {
                    color: ['#00FF00', '#FFFF00', '#FFA500', '#FF0000']
                },
                calculable: true
            },
                            series: [{
                    name: 'å¤§å­¦æ•°é‡',
                    type: 'map',
                    map: mapName,
                    roam: {
                        scale: true,      // å¯ç”¨ç¼©æ”¾
                        move: true,       // å¯ç”¨æ‹–æ‹½
                        scaleLimit: {     // ç¼©æ”¾èŒƒå›´é™åˆ¶
                            min: 0.5,     // æœ€å°ç¼©æ”¾æ¯”ä¾‹ï¼ˆå¯ç¼©å°åˆ°50%ï¼‰
                            max: 3        // æœ€å¤§ç¼©æ”¾æ¯”ä¾‹ï¼ˆå¯æ”¾å¤§åˆ°300%ï¼‰
                        },
                        moveOnMouseMove: false,  // é¼ æ ‡ç§»åŠ¨æ—¶ä¸æ‹–æ‹½ï¼ˆéœ€è¦æŒ‰ä½æ‹–æ‹½ï¼‰
                        moveOnMouseWheel: false  // é¼ æ ‡æ»šè½®æ—¶ä¸æ‹–æ‹½ï¼ˆä»…ç”¨äºç¼©æ”¾ï¼‰
                    },
                    zoom: 1.1,            // åˆå§‹ç¼©æ”¾æ¯”ä¾‹ï¼ˆç¨å¾®æ”¾å¤§ä¸€ç‚¹ï¼‰
                    center: null,         // åœ°å›¾ä¸­å¿ƒç‚¹ï¼ˆnullè¡¨ç¤ºè‡ªåŠ¨å±…ä¸­ï¼‰
                    label: { 
                        show: true,
                        fontSize: 10      // æ ‡ç­¾å­—ä½“å¤§å°
                    },
                    data: data,
                    itemStyle: {
                        areaColor: '#f0f0f0',
                        borderColor: '#ccc',
                        borderWidth: 1
                    },
                    emphasis: {
                        itemStyle: {
                            areaColor: '#e6f7ff',
                            borderColor: '#409EFF',
                            borderWidth: 2
                        }
                    }
                }]
        });
        currentMap = mapName;
        currentTitle = title;
    }

    // é¡¶éƒ¨æ•°æ®æ åˆ·æ–°å‡½æ•°
    function updateStatBar(province = null) {
        let url = '/api/province_stat_bar';
        if (province) url += `?province=${province}`;
        fetch(url).then(r => r.json()).then(data => {
            document.getElementById('stat-total').textContent = data.total;
            document.getElementById('stat-985').textContent = data['985'];
            document.getElementById('stat-211').textContent = data['211'];
            document.getElementById('stat-216').textContent = data['216'];
            document.getElementById('stat-public').textContent = data.public;
            document.getElementById('stat-private').textContent = data.private;
            document.getElementById('stat-other').textContent = data.other;
            document.getElementById('stat-enroll').textContent = data.total_enroll;
        }).catch(error => {
            console.error('Error updating stat bar:', error);
        });
    }

    // æ ¼å¼åŒ–ä¸“ä¸šä»£ç ï¼Œæ¯5ä¸ªä»£ç æ¢è¡Œ
    function formatMajorCodes(codes) {
        if (!codes || codes === '-') return '-';
        
        const codeArray = codes.split(',');
        let formattedCodes = '';
        
        for (let i = 0; i < codeArray.length; i++) {
            if (i > 0 && i % 5 === 0) {
                formattedCodes += '<br>';
            }
            if (i > 0 && i % 5 !== 0) {
                formattedCodes += ',';
            }
            formattedCodes += codeArray[i];
        }
        
        return formattedCodes;
    }

    // é¡µé¢åˆå§‹åŒ–æ—¶åŠ è½½å…¨å›½æ•°æ®
    updateStatBar();

    fetch('/static/maps/china.json').then(r => r.json()).then(geoJson => {
        echarts.registerMap('china', geoJson);
        fetch('/api/province_level_stats').then(r => r.json()).then(data => {
            // åªä¿ç•™ä¸­å›½å¤§é™†çœä»½
            let provinceTotal = data.province_total.filter(item => provinceNameMap[item['çœä»½']]);
            provinceTotalCache = provinceTotal;
            // æ ‡å‡†åŒ–çœä»½å
            provinceTotal = provinceTotal.map(item => ({
                name: provinceNameMap[item['çœä»½']],
                value: item['æ€»æ•°'],
                zh: item['çœä»½']
            }));
            // 2. å±‚æ¬¡æ€»æ•°ï¼ˆé¥¼å›¾ï¼‰
            const levelTotal = data.level_total;
            // 3. çœä»½-å±‚æ¬¡åˆ†å¸ƒï¼ˆå †å æŸ±çŠ¶å›¾ï¼‰
            const provinceLevel = data.province_level;
            // çœä»½åˆ—è¡¨
            const provinces = [...new Set(provinceLevel.map(item => item['çœä»½']))];
            // å±‚æ¬¡åˆ—è¡¨
            const levels = [...new Set(provinceLevel.map(item => item['å±‚æ¬¡']))];
            // å †å æ•°æ®
            const stackedSeries = levels.map(level => ({
                name: level,
                type: 'bar',
                stack: 'total',
                emphasis: { focus: 'series' },
                data: provinces.map(prov => {
                    const found = provinceLevel.find(x => x['çœä»½'] === prov && x['å±‚æ¬¡'] === level);
                    return found ? found['æ•°é‡'] : 0;
                })
            }));

            // 1. ä¸­å›½åœ°å›¾
            mapChart = echarts.init(document.getElementById('chinaMap'));
            mapChart.setOption({
                title: { text: 'å„çœå¤§å­¦æ•°é‡åˆ†å¸ƒ', left: 'center' },
                tooltip: {
                    trigger: 'item',
                    formatter: function(params) {
                        let zhName = provinceNameMapReverse[params.name] || params.name;
                        return `${zhName}ï¼š${params.value || 0} æ‰€å¤§å­¦`;
                    }
                },
                visualMap: {
                    min: 0,
                    max: Math.max(...provinceTotal.map(d=>d.value)),
                    left: 'left',
                    top: 'bottom',
                    text: ['å¤š','å°‘'],
                    inRange: {
                        color: ['#00FF00', '#FFFF00', '#FFA500', '#FF0000']
                    },
                    calculable: true
                },
                series: [{
                    name: 'å¤§å­¦æ•°é‡',
                    type: 'map',
                    map: 'china',
                    roam: {
                        scale: true,      // å¯ç”¨ç¼©æ”¾
                        move: true,       // å¯ç”¨æ‹–æ‹½
                        scaleLimit: {     // ç¼©æ”¾èŒƒå›´é™åˆ¶
                            min: 0.5,     // æœ€å°ç¼©æ”¾æ¯”ä¾‹ï¼ˆå¯ç¼©å°åˆ°50%ï¼‰
                            max: 3        // æœ€å¤§ç¼©æ”¾æ¯”ä¾‹ï¼ˆå¯æ”¾å¤§åˆ°300%ï¼‰
                        },
                        moveOnMouseMove: false,  // é¼ æ ‡ç§»åŠ¨æ—¶ä¸æ‹–æ‹½ï¼ˆéœ€è¦æŒ‰ä½æ‹–æ‹½ï¼‰
                        moveOnMouseWheel: false  // é¼ æ ‡æ»šè½®æ—¶ä¸æ‹–æ‹½ï¼ˆä»…ç”¨äºç¼©æ”¾ï¼‰
                    },
                    zoom: 1.1,            // åˆå§‹ç¼©æ”¾æ¯”ä¾‹ï¼ˆç¨å¾®æ”¾å¤§ä¸€ç‚¹ï¼‰
                    center: null,         // åœ°å›¾ä¸­å¿ƒç‚¹ï¼ˆnullè¡¨ç¤ºè‡ªåŠ¨å±…ä¸­ï¼‰
                    label: { 
                        show: true,
                        fontSize: 10      // æ ‡ç­¾å­—ä½“å¤§å°
                    },
                    data: provinceTotal,
                    itemStyle: {
                        areaColor: '#f0f0f0',
                        borderColor: '#ccc',
                        borderWidth: 1
                    },
                    emphasis: {
                        itemStyle: {
                            areaColor: '#e6f7ff',
                            borderColor: '#409EFF',
                            borderWidth: 2
                        }
                    }
                }]
            });

            // äº‹ä»¶æ³¨å†Œå¿…é¡»åœ¨mapChartåˆå§‹åŒ–å
            mapChart.on('click', function(params) {
                // åªå¤„ç†çœçº§åŒºåŸŸ
                const zhName = params.name;
                if (!provinceEnMap[zhName]) return;
                const enName = provinceEnMap[zhName];
                currentProvince = zhName;
                
                fetch(`/static/maps/${enName}.json`).then(r => r.json()).then(provGeoJson => {
                    // åŒæ—¶è¯·æ±‚åŸå¸‚æ•°æ®å’Œå±‚æ¬¡åˆ†å¸ƒæ•°æ®
                    Promise.all([
                        fetch(`/api/city_university_stats?province=${provinceNameMapReverse[zhName]}`),
                        fetch(`/api/province_level_distribution?province=${provinceNameMapReverse[zhName]}`)
                    ]).then(responses => Promise.all(responses.map(r => r.json()))).then(([cityData, levelData]) => {
                        // å‡†å¤‡åŸå¸‚æ•°æ®
                        let cityMapData = [];
                        let maxCount = 0;
                        
                        // å¤„ç†åŸå¸‚æ•°æ®
                        cityData.city_stats.forEach(item => {
                            if (item.åŸå¸‚ && item.åŸå¸‚ !== 'None' && item.åŸå¸‚ !== 'nan') {
                                cityMapData.push({
                                    name: item.åŸå¸‚,
                                    value: item.æ•°é‡
                                });
                                maxCount = Math.max(maxCount, item.æ•°é‡);
                            }
                        });
                        
                        // å¦‚æœæœ‰çœçº§æ•°æ®ï¼Œæ·»åŠ ä¸€ä¸ªè™šæ‹Ÿçš„çœçº§åŒºåŸŸ
                        if (cityData.province_count > 0) {
                            cityMapData.push({
                                name: zhName,
                                value: cityData.province_count
                            });
                            maxCount = Math.max(maxCount, cityData.province_count);
                        }
                        
                        // æ¸²æŸ“çœä»½åœ°å›¾
                        renderMap(enName, provGeoJson, zhName + 'å¤§å­¦æ•°é‡åˆ†å¸ƒ', cityMapData, true);
                        
                        // æ›´æ–°visualMap
                        mapChart.setOption({
                            visualMap: {
                                min: 0,
                                max: maxCount,
                                left: 'left',
                                top: 'bottom',
                                text: ['å¤š','å°‘'],
                                inRange: {
                                    color: ['#00FF00', '#FFFF00', '#FFA500', '#FF0000']
                                },
                                calculable: true
                            },
                            tooltip: {
                                trigger: 'item',
                                formatter: function(params) {
                                    return `${params.name}ï¼š${params.value || 0} æ‰€å¤§å­¦`;
                                }
                            }
                        });
                        
                        // æ›´æ–°å³ä¾§å›¾è¡¨
                        updateRightCharts(zhName, cityMapData, levelData.level_stats);
                        
                        // æ›´æ–°è¡¨æ ¼ä¸ºå½“å‰çœä»½çš„æ•°æ®
                        loadUniversityTable(provinceNameMapReverse[zhName], 1);
                        updateStatBar(provinceNameMapReverse[zhName]);
                    });
                });
            });
            
            // æ·»åŠ åŒå‡»äº‹ä»¶è¿”å›å…¨å›½è§†å›¾
            mapChart.on('dblclick', function(params) {
                if (currentMap !== 'china') {
                    // è¿”å›å…¨å›½è§†å›¾
                    currentProvince = null;
                    renderMap('china', geoJson, 'å„çœå¤§å­¦æ•°é‡åˆ†å¸ƒ', provinceTotalCache.map(item => ({
                        name: provinceNameMap[item['çœä»½']],
                        value: item['æ€»æ•°']
                    })));
                    resetRightCharts();
                    // æ›´æ–°è¡¨æ ¼ä¸ºå…¨å›½æ•°æ®
                    loadUniversityTable(null, 1);
                    updateStatBar();
                }
            });

            // 2. å„çœå¤§å­¦æ•°é‡ - ç¯å½¢å›¾
            provincePie = echarts.init(document.getElementById('barChart'));
            provincePie.setOption({
                title: { text: 'å„çœå¤§å­¦æ•°é‡', left: 'center' },
                tooltip: { trigger: 'item', formatter: function(params) { return params.name + 'ï¼š' + params.value + 'æ‰€'; } },
                series: [{
                    name: 'å¤§å­¦æ•°é‡',
                    type: 'pie',
                    radius: ['40%', '70%'],
                    center: ['60%', '55%'],
                    data: provinceTotal,
                    emphasis: {
                        itemStyle: { shadowBlur: 10, shadowOffsetX: 0, shadowColor: 'rgba(0, 0, 0, 0.5)' }
                    },
                    label: { formatter: '{b}' }
                }]
            });

            // 3. é¥¼å›¾
            pieChart = echarts.init(document.getElementById('pieChart'));
            pieChart.setOption({
                title: { text: 'å¤§å­¦å±‚æ¬¡å æ¯”', left: 'center' },
                tooltip: { trigger: 'item' },
                series: [{
                    name: 'å±‚æ¬¡',
                    type: 'pie',
                    radius: '60%',
                    data: levelTotal.map(item => ({name: item['å±‚æ¬¡'], value: item['æ€»æ•°']})),
                    emphasis: {
                        itemStyle: { shadowBlur: 10, shadowOffsetX: 0, shadowColor: 'rgba(0, 0, 0, 0.5)' }
                    }
                }]
            });

            // ç»Ÿè®¡æ æ•°æ®é€šè¿‡updateStatBar()ç»Ÿä¸€å¤„ç†ï¼Œä¸éœ€è¦åœ¨è¿™é‡Œé‡å¤è®¾ç½®
            
            // åˆå§‹åŒ–åŠ è½½å…¨å›½å¤§å­¦è¡¨æ ¼
            loadUniversityTable(null, 1);
        });
    });
    </script>
</body>
</html> 